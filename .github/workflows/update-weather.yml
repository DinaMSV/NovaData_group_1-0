name: Update Our Weather

on:
  schedule:
    - cron: '0 * * * *'     # –∫–∞–∂–¥—ã–π —á–∞—Å, –Ω–∞—á–∞–ª–æ —á–∞—Å–∞ (UTC)
  workflow_dispatch:       # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

permissions:
  contents: write          # —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

jobs:
  update-weather:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Update README via Python
        env:
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
        run: |
          python - << 'EOF'
          import os, re
          import requests
          from datetime import datetime, timezone, timedelta

          # 1. –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∏—Ö –≥–æ—Ä–æ–¥–æ–≤
          targets = {
            "aytomaximo": "Moscow",
            "sychtx":     "Nizhny Novgorod",
            "Dina_Mo":    "Stupino"
          }

          # 2. –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (UTC+3)
          now = datetime.now(timezone.utc).astimezone(timezone(timedelta(hours=3))).strftime('%Y-%m-%d %H:%M GMT%z')

          # 3. –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É —Å –¥–∞—Ç–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–∏–≤–æ–º
          updated_line = f"_–û–±–Ω–æ–≤–ª–µ–Ω–æ: {now}_\n\n"

          # 4. –ù–∞—á–∞—Ç—å —Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–≤—ã–π –±–ª–æ–∫ –º–µ–∂–¥—É –º–∞—Ä–∫–µ—Ä–∞–º–∏
          new_block = (
              "<!-- WEATHER:START -->\n"
              f"{updated_line}"
              "| –ß–ª–µ–Ω –∫–æ–º–∞–Ω–¥—ã  | –ì–æ—Ä–æ–¥               | üå°Ô∏è –¢–µ–º–ø.  | –£—Å–ª–æ–≤–∏—è          |\n"
              "|---------------|---------------------|-----------|--------------------|\n"
          )

          # 5. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
          api_key = os.environ['WEATHER_API_KEY']
          for user, city in targets.items():
              url = f"http://api.weatherapi.com/v1/current.json?key={api_key}&q={city}&aqi=no"
              data = requests.get(url).json()

              temp = data['current']['temp_c']
              cond = data['current']['condition']['text']
              icon = data['current']['condition']['icon']
              # –µ—Å–ª–∏ icon –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "//", –¥–æ–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª
              if icon.startswith("//"):
                  icon = "https:" + icon

              new_block += (
                f"| @{user:<13} | {city:<19} | {temp:>6.1f}¬∞C | ![]({icon}) {cond:<12} |\n"
              )

          # 6. –ó–∞–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –∏ –∑–∞–º–µ–Ω—è–µ–º –µ–≥–æ –≤ README.md
          new_block += "<!-- WEATHER:END -->"
          path = "README.md"
          text = open(path, encoding="utf-8").read()
          pattern = r"<!-- WEATHER:START -->.*?<!-- WEATHER:END -->"
          updated = re.sub(pattern, new_block, text, flags=re.DOTALL)

          with open(path, "w", encoding="utf-8") as f:
              f.write(updated)
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add README.md
            git commit -m "chore: –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–≥–æ–¥–∞ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≥–æ—Ä–æ–¥–æ–≤"
            git push
          else
            echo "No changes to commit"
          fi