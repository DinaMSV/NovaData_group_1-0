name: Update Our Weather

on:
  schedule:
    - cron: '0 * * * *'     # –∫–∞–∂–¥—ã–π —á–∞—Å, –Ω–∞—á–∞–ª–æ —á–∞—Å–∞ (UTC)
  workflow_dispatch:       # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

permissions:
  contents: write          # —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

jobs:
  update-weather:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Update README via Python
        env:
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
        run: |
          python - << 'EOF'
          import os, re
          import requests
          from datetime import datetime, timezone, timedelta

          # 1. –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∏—Ö –≥–æ—Ä–æ–¥–æ–≤
          targets = {
            "aytomaximo": "Moscow",
            "sychtx":     "Nizhny Novgorod",
            "Dina_Mo":    "Stupino"
          }

          # 2. –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (UTC+3)
          now = datetime.now(timezone.utc).astimezone(timezone(timedelta(hours=3))).strftime('%Y-%m-%d %H:%M GMT%z')
          updated_line = f"_–û–±–Ω–æ–≤–ª–µ–Ω–æ: {now}_\n"

          # 3. –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É –¥–ª—è –ê–±–∞–∫–∞–Ω–∞
          api_key = os.environ['WEATHER_API_KEY']
          abakan_url = f"http://api.weatherapi.com/v1/current.json?key={api_key}&q=Abakan&aqi=no"
          aba_data = requests.get(abakan_url).json()
          t_abakan = aba_data['current']['temp_c']
          c_abakan = aba_data['current']['condition']['text']
          i_abakan = aba_data['current']['condition']['icon']
          if i_abakan.startswith("//"):
              i_abakan = "https:" + i_abakan

          # 4. –°—Ç—Ä–æ–∏–º —Ç–∞–±–ª–∏—Ü—É –ø–æ –ê–±–∞–∫–∞–Ω—É
          abakan_table = (
            "#### –ü–æ–≥–æ–¥–∞ –≤ –ê–±–∞–∫–∞–Ω–µ\n\n"
            "| –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ | –£—Å–ª–æ–≤–∏—è |\n"
            "|-------------|----------|\n"
            f"| {t_abakan:.1f}¬∞C     | ![]({i_abakan}) {c_abakan} |\n\n"
          )

          # 5. –°—Ç—Ä–æ–∏–º —Ç–∞–±–ª–∏—Ü—É –ø–æ –¥—Ä—É–≥–∏–º –≥–æ—Ä–æ–¥–∞–º
          team_table = (
            "#### –ü–æ–≥–æ–¥–∞ –≤ –Ω–∞—à–∏—Ö –≥–æ—Ä–æ–¥–∞—Ö\n\n"
            "| –ß–ª–µ–Ω –∫–æ–º–∞–Ω–¥—ã  | –ì–æ—Ä–æ–¥               | üå°Ô∏è –¢–µ–º–ø.  | –£—Å–ª–æ–≤–∏—è          |\n"
            "|---------------|---------------------|-----------|--------------------|\n"
          )

          for user, city in targets.items():
              url = f"http://api.weatherapi.com/v1/current.json?key={api_key}&q={city}&aqi=no"
              data = requests.get(url).json()
              temp = data['current']['temp_c']
              cond = data['current']['condition']['text']
              icon = data['current']['condition']['icon']
              if icon.startswith("//"):
                  icon = "https:" + icon
              team_table += f"| @{user:<13} | {city:<19} | {temp:>6.1f}¬∞C | ![]({icon}) {cond:<12} |\n"

          # 6. –°–æ–±–∏—Ä–∞–µ–º –±–ª–æ–∫ —Ü–µ–ª–∏–∫–æ–º
          new_block = (
            "<!-- WEATHER:START -->\n"
            f"{updated_line}\n"
            f"{abakan_table}"
            f"{team_table}\n"
            "<!-- WEATHER:END -->"
          )

          # 7. –û–±–Ω–æ–≤–ª—è–µ–º README.md
          path = "README.md"
          text = open(path, encoding="utf-8").read()
          pattern = r"<!-- WEATHER:START -->.*?<!-- WEATHER:END -->"
          updated = re.sub(pattern, new_block, text, flags=re.DOTALL)
          with open(path, "w", encoding="utf-8") as f:
              f.write(updated)
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add README.md
            git commit -m "chore: –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–≥–æ–¥–∞ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≥–æ—Ä–æ–¥–æ–≤"
            git push
          else
            echo "No changes to commit"
          fi